<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GEMMA</title>
<style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f8f9fa;
            margin: 0;
            padding: 0;
        }

        .container {
            max-width: 800px;
            margin: auto;
        }

        .p-5 {
            padding: 5rem !important;
        }

        .p-4 {
            padding: 4rem !important;
        }

        .col-md-6 {
            width: 50%;
            float: left;
        }

        .card-body {
            background-color: #fff;
            border: 1px solid #dee2e6;
            border-radius: 0.25rem;
            padding: 1.25rem;
            margin-bottom: 1rem;
        }

        .fb-login-button {
            margin-top: 1rem;
        }
        #status {
            margin-top: 1rem;
        }
    </style>
    <!-- Incluye el SDK de Facebook -->
    <script async defer crossorigin="anonymous" src="https://connect.facebook.net/es_LA/sdk.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-app.js";
        import { getFirestore, collection, getDocs, onSnapshot } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-firestore.js";

        // TODO: Add SDKs for Firebase products that you want to use
        // https://firebase.google.com/docs/web/setup#available-libraries

        // Your web app's Firebase configuration
        const firebaseConfig = {

            apiKey: "AIzaSyAozZm8FRSn9uMa6plxuL0PXlGYH2b9Sos",

            authDomain: "prueba-e44fc.firebaseapp.com",

            projectId: "prueba-e44fc",

            storageBucket: "prueba-e44fc.appspot.com",

            messagingSenderId: "439748782067",

            appId: "1:439748782067:web:2eb066c3fb5cb3992a5486"

        };


        // Initialize Firebase
        const app = initializeApp(firebaseConfig);

        const db = getFirestore(app);
        const reportesContainer = document.getElementById("reportes-container");

        const obtenerReportes = async () => {
            const querySnapshot = await getDocs(collection(db, 'reportes'));
            return querySnapshot;
        };
        const onGetReportes = (callback) => {
            const query = collection(db, 'reportes');

            const unsubscribe = onSnapshot(query, (querySnapshot) => {
                callback(querySnapshot);
            });

            // Devolvemos la función para desuscribirse cuando sea necesario
            return unsubscribe;
        }

        window.addEventListener('DOMContentLoaded', async () => {
            try {
                const unsubscribe = onGetReportes((querySnapshot) => {
                    reportesContainer.innerHTML = "";  // Limpiamos el contenedor antes de agregar nuevos elementos
                    querySnapshot.forEach((doc) => {
                        const reporte = doc.data();
                        reportesContainer.innerHTML += `<div class="car card-body mt-2 border-primary"> 
                    <div>
                        <img src=" ${reporte.imagenURL}" length ="100" width="100">
                    </div>
                    <p>${reporte.ubicacion}</p>
                    <p>${reporte.descripcion}</p>
                </div>`;
                    });
                });

                // Puedes usar `unsubscribe` para dejar de escuchar los cambios en algún momento
                // Por ejemplo, si dejas la página o dejas de necesitar las actualizaciones en tiempo real
                // unsubscribe();
            } catch (error) {
                console.error('Error al obtener reportes:', error);
            }
        });


function checkLoginState() {
    FB.getLoginStatus(function (response) {
        statusChangeCallback(response);
    });
}
function statusChangeCallback(response) { 
    console.log('statusChangeCallback');
    console.log(response);                   
    if (response.status === 'connected') {   
        var accessToken = response.authResponse.accessToken;
        var userId = response.authResponse.userID;

        FB.api('/' + userId + '/accounts', 'GET', { access_token: accessToken }, function (response) {
            if (response && !response.error) {
                console.log(response);

                for (var i = 0; i < response.data.length; i++) {
                    var page = response.data[i];
                    console.log('ID de la página: ' + page.id);
                    console.log('Nombre de la página: ' + page.name);
                }
            }
        });
        console.log(accessToken)
        console.log(userId)

        testAPI();
    } else {                                
        document.getElementById('status').innerHTML = 'Please log ' +
            'into this webpage.';
    }
}
window.fbAsyncInit = function () {
    FB.init({
        appId: '1853633641760357',
        cookie: true,                     
        xfbml: true,                   
        version: 'v18.0'          
    });

    // USAR METODO POST Y API TOKEN, PARAMETROS: TITLE, CONTENT 
    FB.getLoginStatus(function (response) {   
        statusChangeCallback(response);       
    });
checkLoginState();
};

function testAPI() {                     
    console.log('Welcome!  Fetching your information.... ');
    FB.api('/me', function (response) {
        console.log('Successful login for: ' + response.name);
        document.getElementById('status').innerHTML =
            'Thanks for logging in, ' + response.name + '!';
    });
}
    </script>
</head>

<body>

    <div class="container p-5 justify-content-center text-center">
        <div class="container p-4">
            <div class="col-md-6" id="reportes-container">

            </div>
        </div>
    </div>

    <fb:login-button scope="public_profile,email" onlogin="checkLoginState();">

    </fb:login-button>
   
    <div id="status">
    </div>

    <!-- Load the JS SDK asynchronously -->
    <script async defer crossorigin="anonymous" src="https://connect.facebook.net/es_LA/sdk.js"></script>

</body>

</html>